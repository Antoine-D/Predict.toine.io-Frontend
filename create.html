
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Stock Predictor</title>

    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/custom.css" rel="stylesheet">
  </head>

  <body>

    <div class="container">
      <form action="http://104.131.219.239:3060/createprediction">
      <div class="jumbotron">
        <div>
          <select id="selected-symbol" class='form-control symbol-dropdown'>
          </select>
        </div>
      </div>

      <div id="stock-price-history" class="jumbotron" style="display: none;">
        <h3 style="text-align: center;"><span id="chart-header-symbol" style="color: #53B981;"></span> Stock Price Past 24 Hours</h3>
          <div id="price-history-chart" style="min-width: 310px; height: 400px; margin: 0 auto; padding-bottom: 10px;"></div>
      </div>

      <div id="prediction-sentence" class="jumbotron" style="display: none; font-size: 200%; margin-left: 0px; color: #53B981;">
        <p>
          <span style="font-size: 130%;">I predict</span> <span id="symbol-span" style="background-color: black; color: #FFCC00; padding: 4px; border-radius: 4px;">AAPL</span> <span style="font-size: 130%;">will</span> 
          <select id="p-action">
            <option>reach above</option>
            <option>sink below</option>
            <option>stay above</option>
            <option>stay below</option>
          </select>
        </p>
        <p>
          $<input id="p-metric" type="number" style="width: 100px;" min="0" max="100.00"> <span style="font-size: 130%;">by</span> <input id="p-end-time" type="time"> <span style="font-size: 130%;">on</span>
        </p>
        <p>
          <select id="p-end-month">
            <option>May</option>
            <option>June</option>
          </select>
          <input id="p-end-day" type="number" style="width: 50px;" min="1" max="31">
          <input id="p-end-year" type="number" style="width: 70px;" min="2015" max="2016">
        </p>

        <button id="p-create-button" href="#predictions-search-section" class="btn btn-lg btn-custom main-button">Create Prediction</button>
      </div>
      </form>

      <footer style="display: none;" class="row">
        <hr>
        <p class="col-lg-6">
          <span style="background-color: #53B981;" class="badge">
            <a style="color: white;" href="/.">Home</a></span>
          </span>
          <span style="background-color: #53B981;" class="badge">
            <a style="color: white;" href="create">Create</a></span>
          </span>
        </p>
        <p class="col-lg-6" id="copyright-notice">&copy; <a class="a-custom" href="http://www.antoinedahan.com">Antoine Dahan</a></p>
      </footer>
    </div> <!-- /container -->


  </body>
  
  <script src="assets/js/jquery-1.11.3.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>

  <script>
    $(document).ready(function() {

        /**
          * When the prediction creation button is clicked, send the prediction 
          * data to the server.
          */
        $("#p-create-button").on("click", function() {
            alert("create clicked");
        });

        $("#selected-symbol").on("change", function () {
            var selectedSymbol = $("#selected-symbol").val();
            $("#symbol-span").html(selectedSymbol);
            $("#chart-header-symbol").html(selectedSymbol);
            
            var stockHistoryToday;
            var nowTime = parseInt((new Date).getTime()/1000);
            var yesterdayTime = parseInt((new Date).getTime()/1000);
            populatePriceHistoryGraph($("#p-object").val(), nowTime, yesterdayTime);

            $("#stock-price-history").show();
            $("#prediction-sentence").show();
        
            // show the footer and set copyright year in footer
            $($("footer")[0]).show();
            $("#copyright-notice").html(
                $("#copyright-notice").html() + " " + (new Date()).getFullYear());
      });

      var restore_price_style_timeout;
      $("#test-price-move-button").on("click", function() {
        clearTimeout(restore_price_style_timeout);
        $("#current-price").addClass("price-move-blink");
        restore_price_style_timeout = setTimeout(function() { 
          $("#current-price").removeClass("price-move-blink");
        }, 800);
      });

      /**
        * Populate the stocks symbol dropdown
        */
      var populateSymbolsDropdown = function () {
        // grab the stocks symbols and names
        var stocksInfoEndpoint = "http://104.131.219.239:3060/objects?type=stock";
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", stocksInfoEndpoint, true);
        xmlhttp.onreadystatechange=function() {
          // if the status is correct, attempt to parse the response as an object
          if(xmlhttp.readyState==4 && xmlhttp.status==200) {
            var rawStocksInfoData = xmlhttp.responseText;
            rawStocksInfoData = JSON.parse(rawStocksInfoData);
            stocksList = Array();
            // create object for the symbol and company name for each equity
            for(var i = 0; i < rawStocksInfoData.objects.length; i++) {
              var stockObject = {};
              stockObject.symbol = rawStocksInfoData.objects[i].name.split(" ")[0].trim();
              var nameIndex = rawStocksInfoData.objects[i].name.indexOf(stockObject.symbol) 
                + stockObject.symbol.length;
              stockObject.name = rawStocksInfoData.objects[i].name.substring(nameIndex).trim();
              stocksList.push(stockObject);
            }
            // sort the stocks info data array by symbol
            stocksList.sort(function(stockA, stockB) {
              return stockA.symbol.localeCompare(stockB.symbol);
            });
            // clear the dropdown
            $("#selected-symbol").html("");
            // append the default option to the symbol select
            var defaultOption = $("<option selected disabled hidden value=''>Select Stock Symbol</option>");
            $("#selected-symbol").append(defaultOption);
            // populate the countries dropdown
            for(var i = 0; i < stocksList.length; i++) {
              var stockInfoOption = $("<option></option>");
              $(stockInfoOption).val(stocksList[i].symbol);
              $(stockInfoOption).html(stocksList[i].symbol + " " + stocksList[i].name);
              $("#selected-symbol").append(stockInfoOption);
            }
          }
        }
        xmlhttp.send();
      };

      populateSymbolsDropdown();

      /**
        * Return the price history between [startDateTime, endDateTime]
        */
      var populatePriceHistoryGraph = function (symbol, startDateTime, endDateTime) {
        // clear the graph
        $('#price-history-chart').highcharts({});
        
        // create the endpoint GET url with params
        var stockPricesEndpoint = "http://104.131.219.239:3060/objects";
        stockPricesEndpoint += "?";
        stockPricesEndpoint += "symbol=";
        stockPricesEndpoint += encodeURIComponent(String(symbol).trim());
        stockPricesEndpoint += "&start=";
        stockPricesEndpoint += encodeURIComponent(String(startDateTime).trim());
        stockPricesEndpoint += "&end=";
        stockPricesEndpoint += encodeURIComponent(String(endDateTime).trim());
        console.log(stockPricesEndpoint);
        // create the request result handler
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", stockPricesEndpoint, true);
        xmlhttp.onreadystatechange=function() {
          // if the status is correct, attempt to parse the response as an object
          if(xmlhttp.readyState==4 && xmlhttp.status==200) {
              var rawstockPriceHistory = xmlhttp.responseText;
              stockPriceHistory = JSON.parse(rawstockPriceHistory);
              console.log(stockPriceHistory);
              // create seperate lists for prices and dates
              var prices = Array();
              var times = Array(); // epoch times
              for (var i = 0; i < stockPriceHistory.length; i++) {
                  prices.push(stockPriceHistory[i].price);
                  times.push(stockPriceHistory[i].time);
              }
              // draw the graph using the times (x-axis) and prices (y-axis)
              drawPriceGraph(times, prices);
          }
        }

        xmlhttp.send();
      };

      var drawPriceGraph = function (times, prices) {
          // populate the chart
          $('#stock-price-history').highcharts({
              chart: {
                  zoomType: 'xy'
              },
              colors: ['#53B981'],
              title: {
                  text: ''
              },
              subtitle: {
                  text: ''
              },
              exporting: {
                  enabled: false
              },
              xAxis: [{
                  categories: times,
                  crosshair: true,
                  title: {
                      text: '<br/>Date and Time (EST)',
                      style: {
                          color: '#333A45'
                      }
                  },
                  labels: {
                      enabled: false
                  }
              }],
              yAxis: [{
                  min: Math.min.apply(Math, stockHistoryToday.prices),
                  gridLineWidth: 0,
                  title: {
                      text: 'Price ($)',
                      style: {
                          color: '#333A45'
                      }
                  },
                  labels: {
                      format: '{value}',
                      style: {
                          color: '#333A45'
                      }
                  }
              }],
              legend: {
                  shared: true,
                  enabled: false
              },
              series: [{
                  name: 'Price',
                  yAxis: 0,
                  data: prices,
                  tooltip: {
                      valuePrefix: '$'
                  }
              }]
          });

          // clear highcharts graph footer
          $($('body').find("text")[$('body').find("text").length - 1]).html("");  
      }
    });
  </script>
</html>

