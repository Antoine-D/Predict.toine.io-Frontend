
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Stock Predictor</title>

    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/custom.css" rel="stylesheet">
  </head>

  <body>

    <div class="container">
      <div class="jumbotron">
        <div>
          <select id="selected-symbol" class='form-control symbol-dropdown'>
          </select>
        </div>
      </div>

      <div id="stock-price-history" class="jumbotron" style="display: none;">
        <h3 style="text-align: center;"><span id="chart-header-symbol" style="color: #53B981;"></span> Stock Price Past 24 Hours</h3>
          <div id="price-history-chart" style="min-width: 310px; height: 400px; margin: 0 auto; padding-bottom: 10px;"></div>
      </div>

      <div id="prediction-sentence" class="jumbotron" style="display: none; font-size: 200%; margin-left: 0px; color: #53B981;">
        <p>
          <span style="font-size: 130%;">I predict</span> <span id="p-object" style="background-color: black; color: #FFCC00; padding: 4px; border-radius: 4px;"></span> <span style="font-size: 130%;">will</span> 
          <select id="p-action">
            <option>reach above</option>
            <option>sink below</option>
            <option>stay above</option>
            <option>stay below</option>
          </select>
        </p>
        <p>
          $<input id="p-value" type="number" value="100.00" step="0.01" style="width: 100px;" min="0" max="100.00"> <span style="font-size: 130%;">by</span> <input id="p-end-time" type="time" value="13:33"> <span style="font-size: 130%;">on</span>
        </p>
        <p>
          <select id="p-end-year"></select>
          <select id="p-end-month"></select>
          <select id="p-end-day"></select>
        <p>
            <input id="p-predictor" placeholder="Email or identity phrase" type="text">
        </p>

        <button id="p-create-button" class="btn btn-lg btn-custom main-button">Create Prediction</button>
      </div>

      <form id="prediction-creation-form" action="http://104.131.219.239:3060/createprediction" method="post" style="display: none;">
          <input id="prediction-create-form-predictor" name="predictor" />
          <input id="prediction-create-form-type" name="type" value="stock"/>
          <input id="prediction-create-form-object" name="object" />
          <input id="prediction-create-form-action" name="action" />
          <input id="prediction-create-form-value" name="value" />
          <input id="prediction-create-form-end" name="end" />
      </form>

      <footer style="display: none;" class="row">
        <hr>
        <p class="col-lg-6">
          <span style="background-color: #53B981;" class="badge">
            <a style="color: white;" href="/.">Home</a>
          </span>
          <span style="background-color: #53B981;" class="badge">
            <a style="color: white;" href="create">Create</a>
          </span>
          <div id="prediction-create-errors" style="display: none;"></div>
        </p>
        <p class="col-lg-6" id="copyright-notice">&copy; <a class="a-custom" href="http://www.antoinedahan.com">Antoine Dahan</a></p>
      </footer>
    </div> <!-- /container -->


  </body>
  
  <script src="assets/js/jquery-1.11.3.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>

  <script>
    $(document).ready(function() {
        var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        /**
          * When the prediction creation button is clicked, send the prediction 
          * data to the server.
          */
        $("#p-create-button").on("click", function() {
            // clear the errors area
            $("#prediction-create-errors").html("");
            $("#prediction-create-errors").hide();
            // grab the input values
            var endYear = $("#p-end-year").val();
            var endMonth = $("#p-end-month").val();
            var endDay = $("#p-end-day").val();
            var endTime = $("#p-end-time").val();
            var predictor = $("#p-predictor").val();
            var object = $("#p-object").html();
            var action = $("#p-action").val();
            var value = $("#p-value").val();
            // check the required fields are all filled
            if (endYear.length > 0
                && endMonth.length > 0
                && endDay.length > 0
                && endTime.trim().length > 0
                && endTime.indexOf(":") > -1
                && predictor.trim().length > 0
                && object.trim().length > 0
                && action.trim().length > 0
                && value.trim().length > 0) {
                // create the end date object for the prediction end
                var colonIndex = endTime.indexOf(":");
                var hour = parseInt(endTime.substring(0, colonIndex));
                var minute = parseInt(endTime.substring(colonIndex + 1));
                var endDate = new Date(parseInt(endYear), monthNames.indexOf(endMonth), parseInt(endDay), hour, minute, 0, 0);

                // fill out prediction creation form and post it to the server
                $("#prediction-create-form-predictor").val(predictor);
                $("#prediction-create-form-object").val(object);
                $("#prediction-create-form-action").val(action);
                $("#prediction-create-form-value").val(value);
                var endDateUnixTime = Math.floor(endDate.getTime() / 1000);
                $("#prediction-create-form-end").val(endDateUnixTime);
                $("#prediction-creation-form").submit();
            }

            else {
                var errorMessage = "";
                if (endYear.length == 0) {
                    errorMessage += "Prediction end Year input was left blank.";
                    errorMessage += "<br/>";
                }
                if (endMonth.length == 0) {
                    errorMessage += "Prediction end Month input was left blank.";
                    errorMessage += "<br/>";
                }
                if (endDay.length == 0) {
                    errorMessage += "Prediction end Day input was left blank.";
                    errorMessage += "<br/>";
                }
                if (endTime.trim().length == 0 || endTime.indexOf(":") == -1) {
                    errorMessage += "Prediction end time input is not complete (make sure hour, minutes, and AM/PM is set.";
                    errorMessage += "<br/>";
                }
                if (predictor.trim().length == 0) {
                    errorMessage += "The email or phrase to assosiate with this prediction was left blank. Filling this in with an email/phrase allows you to view all your predictions on one page and share them with friends.";
                    errorMessage += "<br/>";
                }
                if (object.trim().length == 0) {
                    errorMessage += "The name of the stock was left blank.";
                    errorMessage += "<br/>";
                }
                if(action.trim().length == 0) {
                    errorMessage += "The action of your prediction was left blank.";
                    errorMessage += "<br/>";
                }
                if(value.trim().length == 0) {
                    errorMessage += "The price of the stock was left blank.";
                    errorMessage += "<br/>";
                }
                alert(errorMessage);
                $("#prediction-create-errors").html(errorMessage);
                $("#prediction-create-errors").show();
            }
        });

        var populateEndDateMonthOptions = function(endYear) {
          // clear current month options
          $("#p-end-month").html("");
          var startMonth = (endYear == (new Date()).getFullYear()) ? (new Date()).getMonth() : 0;
          for(var monthIndex = startMonth; monthIndex < 12; monthIndex++) {
            var monthOption = $("<option></option>");
            monthOption.val(monthNames[monthIndex]);
            monthOption.html(monthNames[monthIndex]);
            $("#p-end-month").append(monthOption);
          }
        }

        var populateDayOptions = function(endMonth) {
          $("#p-end-day").html("");
          var startDay = 1;
          // if selected month is current month, then start day is current day
          if(monthNames.indexOf(endMonth) == (new Date()).getMonth() &&
            $("#p-end-year").val() == (new Date()).getFullYear()) {
            startDay = (new Date()).getDate();
          }
          // get number of days in the month
          var numberOfDaysInMonth = getNumberOfDaysInMonth(
            $("#p-end-month").val(), 
            $("#p-end-year").val());
          // append the days onto the day dropdown
          for(var dayIterator = startDay; dayIterator <= numberOfDaysInMonth; dayIterator++) {
            var dayOption = $("<option></option>");
            dayOption.val(dayIterator);
            dayOption.html(dayIterator);
            $("#p-end-day").append(dayOption);
          }
        }

        var populateEndDateOptions = function() {
          // clear the end date dropdowns
          $("#p-end-day").html("");
          $("#p-end-month").html("");
          $("#p-end-year").html("");
          // populate the end year dropdown
          var currentDate = new Date();
          var currentYearOption = $("<option></option>");
          $(currentYearOption).val(currentDate.getFullYear());
          $(currentYearOption).html(currentDate.getFullYear());
          $("#p-end-year").append(currentYearOption);
          var nextYearOption = $("<option></option>");
          $(nextYearOption).val(currentDate.getFullYear() + 1);
          $(nextYearOption).html(currentDate.getFullYear() + 1);
          $("#p-end-year").append(nextYearOption);
          // populate the end month dropdown
          populateEndDateMonthOptions($("#p-end-year").val());
          // populate the end day dropdown
          populateDayOptions($("#p-end-month").val());
        }

        $("#p-end-month").on("change", function () {
          populateDayOptions($(event.target).val());
        });

        $("#p-end-year").on("change", function () {
          populateEndDateMonthOptions($("#p-end-year").val());
          populateDayOptions($(event.target).val());
        });

        var getNumberOfDaysInMonth = function(month, year) {
          return (new Date(parseInt(year), monthNames.indexOf(month)+1, 0)).getDate();
        }

        $("#selected-symbol").on("change", function () {
            var selectedSymbol = $("#selected-symbol").val();
            $("#p-object").html(selectedSymbol);
            $("#chart-header-symbol").html(selectedSymbol);
            
            // populate the price history graph using the stock symbol, the epoch time now, 
            // and the epoch time 24 hours hours ago.
            var nowTime = parseInt((new Date).getTime()/1000);
            var yesterdayTime = parseInt((new Date).getTime()/1000) - (24*60*60);
            populatePriceHistoryGraph($(event.target).val(), yesterdayTime, nowTime);

            populateEndDateOptions();
            $("#stock-price-history").show();
            $("#prediction-sentence").show();
        
            // show the footer and set copyright year in footer
            $($("footer")[0]).show();
            $("#copyright-notice").html(
                $("#copyright-notice").html() + " " + (new Date()).getFullYear());
      });

      var restore_price_style_timeout;
      $("#test-price-move-button").on("click", function() {
        clearTimeout(restore_price_style_timeout);
        $("#current-price").addClass("price-move-blink");
        restore_price_style_timeout = setTimeout(function() { 
          $("#current-price").removeClass("price-move-blink");
        }, 800);
      });

      /**
        * Populate the stocks symbol dropdown
        */
      var populateSymbolsDropdown = function () {
        // grab the stocks symbols and names
        var stocksInfoEndpoint = "http://104.131.219.239:3060/objects?type=stock";
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", stocksInfoEndpoint, true);
        xmlhttp.onreadystatechange=function() {
          // if the status is correct, attempt to parse the response as an object
          if(xmlhttp.readyState==4 && xmlhttp.status==200) {
            var rawStocksInfoData = xmlhttp.responseText;
            var stocksList = JSON.parse(rawStocksInfoData).objects;
            // sort the stocks info data array by symbol
            stocksList.sort(function (stockA, stockB) {
                return stockA.object.localeCompare(stockB.object);
            });
            // clear the dropdown
            $("#selected-symbol").html("");
            // append the default option to the symbol select
            var defaultOption = $("<option selected disabled hidden value=''>Select Stock Symbol</option>");
            $("#selected-symbol").append(defaultOption);
            // populate the countries dropdown
            for(var i = 0; i < stocksList.length; i++) {
              var stockInfoOption = $("<option></option>");
              $(stockInfoOption).val(stocksList[i].object);
              $(stockInfoOption).html(stocksList[i].object + " " + stocksList[i].company);
              $("#selected-symbol").append(stockInfoOption);
            }
          }
        }
        xmlhttp.send();
      };

      populateSymbolsDropdown();

      /**
        * Return the price history between [startDateTime, endDateTime]
        */
      var populatePriceHistoryGraph = function (symbol, startDateTime, endDateTime) {
        // clear the graph
        $('#price-history-chart').highcharts({});
        
        // create the endpoint GET url with params
        var stockPricesEndpoint = "http://104.131.219.239:3060/objects?type=stock";
        stockPricesEndpoint += "&object=";
        stockPricesEndpoint += encodeURIComponent(String(symbol).trim());
        stockPricesEndpoint += "&includeValues=y";
        stockPricesEndpoint += "&start=";
        stockPricesEndpoint += encodeURIComponent(String(startDateTime).trim());
        stockPricesEndpoint += "&end=";
        stockPricesEndpoint += encodeURIComponent(String(endDateTime).trim());
        console.log(stockPricesEndpoint);
        // create the request result handler
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", stockPricesEndpoint, true);
        xmlhttp.onreadystatechange=function() {
          // if the status is correct, attempt to parse the response as an object
          if(xmlhttp.readyState==4 && xmlhttp.status==200) {
              var rawstockPriceHistory = xmlhttp.responseText;
              var stockPriceHistory = JSON.parse(rawstockPriceHistory).objects;
              console.log(stockPriceHistory);
              // create seperate lists for prices and dates
              var prices = Array();
              var times = Array(); // epoch times
              for (var i = 0; i < stockPriceHistory.length; i++) {
                  prices.push(stockPriceHistory[i].value);
                  times.push(stockPriceHistory[i].time);
              }
              // draw the graph using the times (x-axis) and prices (y-axis)
              drawPriceGraph(times, prices);
          }
        }

        xmlhttp.send();
      };

      var drawPriceGraph = function (times, prices) {
          // populate the chart
          $('#stock-price-history').highcharts({
              chart: {
                  zoomType: 'xy'
              },
              colors: ['#53B981'],
              title: {
                  text: ''
              },
              subtitle: {
                  text: ''
              },
              exporting: {
                  enabled: false
              },
              xAxis: [{
                  categories: times,
                  crosshair: true,
                  title: {
                      text: '<br/>Date and Time (EST)',
                      style: {
                          color: '#333A45'
                      }
                  },
                  labels: {
                      enabled: false
                  }
              }],
              yAxis: [{
                  min: Math.min.apply(Math, prices),
                  gridLineWidth: 0,
                  title: {
                      text: 'Price ($)',
                      style: {
                          color: '#333A45'
                      }
                  },
                  labels: {
                      format: '{value}',
                      style: {
                          color: '#333A45'
                      }
                  }
              }],
              legend: {
                  shared: true,
                  enabled: false
              },
              series: [{
                  name: 'Price',
                  yAxis: 0,
                  data: prices,
                  tooltip: {
                      valuePrefix: '$'
                  }
              }]
          });

          // clear highcharts graph footer
          $($('body').find("text")[$('body').find("text").length - 1]).html("");  
      }
    });
  </script>
</html>

